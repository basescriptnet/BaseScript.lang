function include(e){let m="";for(let c=0;c<e.length;c++){var h=e[c];if("include"!=e[c].type&&!(e[c].value in libs)){if("math"==e[c].value){useComplexMath=!0;continue}throw Error(`Unknow library "${e[c].value} at line ${e[c].line}, column ${e[c].col}"`);}if("include"==e[c].type){e[c].addon&&e[c].addon.length&&(m+=h(e[c].addon));var g=pathJS(pathJS().relative()),k=g.add(e[c].value);h=fs.readFileSync(k,"utf8");h=parse(to_ast(h));h=minify(h.includes)+"\n"+minify(h.result);g=`const __dirname = "${g.dir.replace(/\//g,
"\\\\")}", __filename = "${k.replace(/\//g,"\\\\")}";\n`;m+=`(function () {${g}${h}}).call(this);\n\n`}else if(h=libs[e[c].value],k=pathJS(__dirname).add(`../../bin/${h}`).replace(/\//g,"\\\\"),g=fs.readFileSync(k,"utf8"),k=`const __dirname = "${pathJS(pathJS().relative()).dir.replace(/\//g,"\\\\")}", __filename = "${k.replace(/\//g,"\\\\")}";\n`,/\.b(s|m)$/i.test(h))m+=`(function () {${k} ${minify(parse(to_ast(g+"\n")).result)}}).call(this);\n\n`;else if(/\.js$/i.test(h))m+=`(function () {${k} ${g}}).call(this);\n\n`;
else throw Error(`Unknow library "${e[c].value} at line ${e[c].line}, column ${e[c].col}"`);}return m}let namespaces=[],useComplexMath=!1,lvl=-1,relPath="",minify=function(e){return e.replace(/[ \t]*\/\/[^\n]*\n*/g,"").replace(/(\r\n?|[ \t])+/g," ").replace(/\s*(,|;|\}|\{)\s+/g,"$1 ").replace(/(?:\s*)(==?=?|<=?|>=?|!==?|\+=|\-=|\*=|\/=|\|\||&&)(?:\s*)/g,"$1")};
const fs=require("fs"),to_ast=require("./text_to_ast.js"),parsersObject={parseMath:"./parse/math.js",parseIf:"./parse/if.js",parseKeyword:"./parse/keyword.js",parseLoop:"./parse/loop.js",parseBlock:"./parse/block.js",parsePrimitive:"./parse/primitive.js",parseVar:"./parse/var.js",parseStatement:"./parse/statement.js",init(){for(let e in this)"string"===typeof this[e]&&(this[e]=require(this[e])(parse));delete this.init;this.findMatch=(e,m,h,g,k,c)=>{for(let a in this)if(this[a].supported&&-1!==this[a].supported.indexOf(e.type))return this[a].parse(e,
m,h,g,k,c,useComplexMath)};return this}}.init(),libs={get random(){return"builtin/random.bm"},get HTML(){return"builtin/HTML.js"},get typedArrays(){return"builtin/typedArrays.bm"},get builtins(){return"../lib/compiler/built_in.min.js"}};
function parse(e,m,h,g,k="",c){if(void 0===e)throw Error('[Internal Error]: "statements" is undefined');Array.isArray(e)||(e=[e]);c="";for(let r=0;r<e.length;r++){var a=e[r];if(null==a){c+=null;break}var b=a.value,d=[],f=parsersObject.findMatch(a,m,h,g,k);if(void 0!==f)c+=f;else switch(a.type){case "decorator":return e=pathJS(pathJS().relative()),h=pathJS(e.path).add(e.name)+baseUrl.ext,e=`const __dirname = "${e.dir.replace(/\//g,"\\\\")}", __filename = "${h.replace(/\//g,"\\\\")}";\n`,h="",a.includes&&
a.includes.length&&(h=include(a.includes)),-1===lvl&&(relPath=m),c+=parse({type:"scope",value:b},m,!1,"global"),namespaces=[],useComplexMath=!1,{result:c,includes:h,dirs:e};case "scope":lvl++;a=namespaces.length;c+=`${parse(b,m,h,g,k)}\n`;a<namespaces.length&&namespaces.splice(a,namespaces.length-a);lvl--;break;case "namespace":namespaces.push(parse(b));break;case "namespace_retraction":d=namespaces[namespaces.length-1];c+=d;if("dot"==a.retraction_type)c+="."+parse(b);else if("item_retraction"==a.retraction_type)c+=
"["+parse(b)+"]";else if("item_retraction_last"==a.retraction_type)c+=`[BS.last(${d}.length - 1)]`;else if("function_call"==a.retraction_type){b=[];for(d=0;d<a.arguments.value.length;d++)b.push(`${parse(a.arguments.value[d])}`);c+=`(${b.join(", ")})`}break;case "interface":c+=`BS.customTypes["${a.identifier}"] = function ${a.identifier}(value) {`;c+="if (!BS.types.Object(value)) return false;";c+=`if (Object.keys(value).length !== ${Object.keys(a.value).length}) return false;`;for(var n in b){a=[];
for(var p in b[n].value)a.push(b[n].is_array[p]?'"'+b[n].value[p]+'[]"':'"'+b[n].value[p]+'"');c+=`if (!BS.validateType(value["${n}"], BS.ifTypeExists([${a.join(", ")}]), ${b[n].nullable})) {
                        return false;
                    }`}c+="return true;";c+="};";break;case "condition_group":for(f=0;f<b.length;f++)d.push(parse(b[f]));c+=d.join(a.separator.replace("or","||").replace("and","&&"));break;case "nullish_check":a=parse(a.condition);b=parse(b);c+=`(((${a}) === null) || (${a}) === void(0)) ? ${b} : ${a}`;break;case "number_negative":c+="-"+parse(b);break;case "ternary":c+=`${parse(b)} ? ${parse(a.left)} : ${null===a.right?null:parse(a.right)}`;break;case "convert":if("string"==typeof a.convert_type.value){c+=
`BS.convert(${parse(b)}, "${a.convert_type.value}")`;break}c+=`(() => {
                    let r = BS.convert(${parse(b)}, "Array");
                    ${parse(a.convert_type)};
                    return r
                })()`;break;case "array_of_type":d=[];if("array_of_type"==a.value.type){c+=`for (let i = 0; i < r.length; i++) {
                        r[i] = BS.convert(r[i], "Array");
                        ${d}
                    }`;break}c+=`for (let i = 0; i < r.length; i++) {
                    r[i] = BS.convert(r[i], "${b.value}");
                }`;break;case "array_interactions":if("spread"==a.method){c+=`...${parse(b)}`;break}if(a.into){c+=`(() => {
                        let v = ${parse(a.into)};
                        v.${a.method.value.toLowerCase()}(${parse(b)});
                        return v;
                    })()`;break}c+=`(() => {
                    let v = ${parse(a.value)};
                    v.${a.method.value.toLowerCase()}();
                    return v;
                })()`;break;case "SAVE":c+=`BS.storage.push(${parse(b)});`;break;case "USE":c+=`(() => {
                    if (BS.storage.length == 0) {
                        throw new Error("No saved values to use at line ${a.line}, col ${a.col}.");
                    }
                    return BS.storage.last();
                })()`;break;case "DELETE":c+="BS.storage.pop();";break;case "dot_retraction_v2":(d=a.check)&&delete a.check;a=parse(a.from);f="";f="identifier"!==b.type?parse(b):b.value;if(!d){c+=`${a}.${f}`;break}c+=`${a} && ${a}.${f}`;break;case "double_dot_retraction":a=parse(a.from);d=[];if(b.length){for(f=0;b&&f<b.length;f++)d.push(`tmp.${parse(b[f])}`);c+=`(() => {
                        let tmp = ${a};
                        ${d.join(";")}
                        return tmp;
                    })()`;break}c+=`${a}.${parse(b)}`;break;case "array_slice":d="string"==typeof b?b:parse(b);c+=`BS.slice(${d}, ${parse(a.start)}, ${null===a.end?null:parse(a.end)}, ${parse(a.step)}, ${a.line}, ${a.col})`;break;case "string_slice":c=c.slice(0,-1);for(f=0;f<b.length;f++)d.push(b[f]);b=a.reversed?d.reverse():d;c+=`"${b.slice(parse(a.start),parse(a.end)).join("")}"`;break;case "name_list":c+=`${parse(b)}, ${parse(a.addition)}`;break;case "iife":c+=`(${parse(b)})(${a.call_arguments.value.map(l=>
parse(l)).join(",")})`;break;case "annonymous_function":b=[];d="";d+=`${a.async?"async ":""}function ${a.identifier?a.identifier.value:""}`;b=a.arguments?parse(a.arguments):["",""];f=!1;var q=a.value[0]&&a.value[0].value&&a.value[0].value.value?a.value[0].value.value.value:null;q&&/use strict/.test(q)&&(a.value=a.value.slice(1),f=!0);q="";let t=[];if(["def","function","void"].includes(a.declarator.value[0]))t.push([a.declarator.value[0],!1]);else{q='throw new TypeError("Invalid return type at line '+
a.line+", col "+a.col+'");';for(let l=0;l<a.declarator.value.length;l++)t.push([`"${a.declarator.value[l]}${a.declarator.is_array[l]?"[]":""}"`])}d+=`(${b.length?b[0]:""}) {\
                    ${f?'"use strict"':""}
                    const args = Array.from(arguments);`+`${b.length?b[1]+"\n":""}${parse(a.value,t,!1,"function")}\
                    ${q}
                }`;if(a.identifier){c+=d;break}c+=`(${d})`;break;case "identifier":if("string"!==typeof b){c+=b.value;break}c+=b;break;case "html_string":d=[];for(a=0;a<b.length;a++)"string"==b[a].type?d.push(b[a].value):d.push(b[a].text);c+=JSON.stringify(d.join(""));break;case "function_call":a.check&&delete a.check;d="";"identifier"==b.type||"keyword"==b.type?d+=parse(b):b.from&&"item_retraction"!=b.type&&(d+=`${parse(b.from)}.`);if(b&&b.value&&b.value instanceof Array)if("array"==b.type)d+=parse(b);
else for(f=0;f<b.value.length;f++)d+=b.value[f].value,f<b.value.length-1&&(d+=".");else"item_retraction"==b.type?d+=parse(b):"object"===typeof b&&"identifier"!=b.type?d="namespace_retraction"==b.type?d+parse(b):"expression_with_parenthesis"===b.type?d+parse(b):"function_call"==b.type?d+parse(b):"identifier"!=b.value.type?d+parse(b.value):d+b.value.value:"object"===typeof b?null:d="namespace_retraction"==b.type?parse(b):"\n"+b;c+=`${d}`;if(!a.arguments.value.length){c+="()";break}c+="(";d=[];for(b=
0;b<a.arguments.value.length;b++)d.push(parse(a.arguments.value[b]));c+=d.join(",");c+=")";break;case "expression":c+=`${parse(b[0])} ${b[1].value} ${parse(b[2])}`;break;case "expression_with_parenthesis":if(!a.arguments){c+=`(${parse(b)})`;break}if(b.result){if(c+=`(${parse(b)})`,a.call_arguments||a.arguments){a=a.call_arguments||a.arguments;b=a.value;d=[];for(f=0;f<b.length;f++)d.push(parse(a.value[f]));c+=`(${d.join(",")})`}}else c+=`(${parse(b)})`;break;case "lambda":b=parse(a.arguments);Array.isArray(b)&&
(b=b.join(""));c+=`(${b}) => {${parse(a.value)}}`;break;case "condition_destructive":if("string"===typeof b)if(void 0!==a.left)for(let l=0,u=a.right.value.length;l<u;l++)c+=`${parse(a.left)}${b}${parse(a.right.value[l])}`,["!=","!==","==","=="].includes(b)?l<u-1&&(c+=" || "):l<u-1&&(c+=" && ");else c+=b;else c+=parse(b,m);break;case "value":c="string"===typeof b?void 0!==a.left?c+`${parse(a.left)}${b}${parse(a.right)}`:c+b:c+parse(b,m,null,g);break;case "@import":d=parse(b).trim();if(/\.js"/i.test(d)){c+=
fs.readFileSync(d.slice(1,-1),"utf8");break}c+=`eval(BS.parse(BS.ast(BS.fs.readFileSync(${d}, 'utf8'))));`;break;case "@include":a=fs.readFileSync(relPath.replace(/\\/g,"/")+"/"+parse(b).slice(1,-1),"utf8");a=parse(to_ast(a));c+=`${a.includes}${a.result}`;break;case "eval":c+=`eval(BS.parse(BS.ast(${parse(b)})));`;break;case "item_retraction":c+=`${parse(a.from)}[${parse(b)}]`;if(a.arguments){d=[];for(b=0;b<a.arguments.value.length;b++)d.push(parse(a.arguments.value[b]));c+=`(${d.join(",")})`}break;
case "item_retraction_last":c+=`${parse(a.from)}[BS.last(${parse(a.from)}.length)]`;if(a.arguments){d=[];for(b=0;b<a.arguments.value.length;b++)d.push(parse(a.arguments.value[b]));c+=`(${d.join(",")})`}break;case "boolean_reversed":c+=`!${parse(b)}`;break;case "bitwise_middle":c+=`${parse(a.left)} ${a.operator} ${parse(a.right)}`;break;case "bitwise_not":c+=`${a.operator}${parse(b)}`;break;case "echo":a=parse(b);c+=`if (typeof ${a} !== 'string') {
                    throw 'echo must be type of string';
                } else {
                    try {
                        eval(${a})
                    } catch (err) {
                        throw new Error(err);
                        //console.warn(\`[Echo error]: \${err}\`);
                    }}`;break;case "html_text":c+=`BS.valueToDOM(${parse(b)})`;break;case "html_expression":c+=`BS.Node("${a.opening_tag}",`;c=a.id?c+`"${a.id.value}", `:c+"null,";if(a.classList){c+='"';for(let l in a.classList)c+=a.classList[l].value+" ";c=c.trimEnd();c+='",'}else c+="null,";if(a.attributes&&a.attributes.length){c+="{";for(let l in a.attributes)c+=a.attributes[l].identifier.value+":",c+=parse(a.attributes[l].value)+",";c+="},"}else c+="null,";if(b){for(a=0;a<b.length;a++)d.push(parse(b[a]));
c+=`[${d.join(",")}]`}else c+="null";c+=")";break;case "html":c+=`BS.Node("${parse(b)}",`;c=a.id?c+`"${a.id.value}", `:c+"null,";if(a.classList){c+='"';for(let l in a.classList)c+=a.classList[l].value+" ";c=c.trimEnd();c+='",'}else c+="null,";a.elements?(a=parse(a.elements),c+=a):c+="null";c+=")";break;case "keyword":c+=b;break;case "es6_key_value":d=parse(a.arguments)||["",""];c+=`${a.key.value} (${d[0]}) {\
                    ${d[1]}
                    ${parse(b)}
                }`;break;case "arguments":c+=b.join(", ");break;case "arguments_with_types":b=[];c=a.identifiers||[];e=a.values;h=a.cancelables;if(0==a.types.length)return"";for(g=0;g<c.length;g++)if(k=e[g]?"="+parse(e[g],m):"",d.push(`${c[g]}${k}`),"none"!==a.types[g][0][0]){k=[];for(n=0;n<a.types[g].length;n++)p=a.types[g][n],p[1]?k.push(`"${p[0]}[]"`):k.push(`"${p[0]}"`);n=null!==e[g]&&void 0!==e[g]?parse(e[g]):`arguments[${g}] ?? null`;k=`BS.checkArgType([${k.join(",")}], "${c[g]}", ${n}, ${a.line}, ${a.col})`;
h[g]&&(k+=`&& ${parse(c[g])} !== null`);k+=";";b.push(k)}return[d.join(", "),b.length?b.join(""):""];case "period":c+=".";break;case "expression_short_equation":c+=`${parse(b[0])} ${parse(b[1])}= ${parse(b[2])}`;break;case void 0:break;default:c+="/* Unhandled expression: "+JSON.stringify(a)+" */"}}return c.trim()}module.exports=parse;
