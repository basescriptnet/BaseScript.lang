(function(n,r){"object"===typeof module&&module.exports?module.exports=r(require("./nearley.js")):n.Compile=r(n.nearley)})(this,function(n){function r(t,f){function h(b,a,c){for(var k=0;k<a.length;k++){var g=b;for(var p=a[k],q=c,u=[],w=0;w<p.tokens.length;w++){var z=y(g,p.tokens[w],q);null!==z&&u.push(z)}g=new n.Rule(g,u,p.postprocess);f.nojs&&(g.postprocess=null);d.rules.push(g)}}function y(b,a,c){if("string"===typeof a)return"null"===a?null:a;if(a instanceof RegExp)return a;if(a.literal)return a.literal.length?
1===a.literal.length||d.config.lexer?a:A(b,a,c):null;if(a.token)return d.config.lexer?(c=a.token,-1===d.customTokens.indexOf(c)&&d.customTokens.push(c),{token:"("+(d.config.lexer+".has("+JSON.stringify(c)+") ? {type: "+JSON.stringify(c)+"} : "+c)+")"}):a;if(a.subexpression)return a=a.subexpression,b=l(b+"$subexpression"),h(b,a,c),b;if(a.ebnf){a:{switch(a.modifier){case ":+":b=l(b+"$ebnf");h(b,[{tokens:[a.ebnf]},{tokens:[b,a.ebnf],postprocess:{builtin:"arrpush"}}],c);c=b;break a;case ":*":b=l(b+"$ebnf");
h(b,[{tokens:[]},{tokens:[b,a.ebnf],postprocess:{builtin:"arrpush"}}],c);c=b;break a;case ":?":b=l(b+"$ebnf");h(b,[{tokens:[a.ebnf],postprocess:{builtin:"id"}},{tokens:[],postprocess:{builtin:"nuller"}}],c);c=b;break a}c=void 0}return c}if(a.macrocall){var k=l(b+"$macrocall"),g=d.macros[a.macrocall];if(!g)throw Error("Unkown macro: "+a.macrocall);if(g.args.length!==a.args.length)throw Error("Argument count mismatch.");for(var p={__proto__:c},q=0;q<g.args.length;q++){var u=l(b+"$macrocall");p[g.args[q]]=
u;h(u,[a.args[q]],c)}h(k,g.exprs,p);return k}if(a.mixin){if(c[a.mixin])return y(b,c[a.mixin],c);throw Error("Unbound variable: "+a.mixin);}throw Error("unrecognized token: "+JSON.stringify(a));}function A(b,a,c){b=l(b+"$string");h(b,[{tokens:a.literal.split("").map(function(k){return{literal:k}}),postprocess:{builtin:"joiner"}}],c);return b}var l=B();f.alreadycompiled||(f.alreadycompiled=[]);for(var d={rules:[],body:[],customTokens:[],config:{},macros:{},start:"",version:f.version||"unknown"},x=0;x<
t.length;x++){var e=t[x];if(e.body)f.nojs||d.body.push(e.body);else if(e.include){if(e=e.builtin?require("path").resolve(__dirname,"../builtin/",e.include):require("path").resolve(f.args&&f.args[0]?require("path").dirname(f.args[0]):process.cwd(),e.include),-1===f.alreadycompiled.indexOf(e)){f.alreadycompiled.push(e);var C=require("fs").readFileSync(e).toString(),v=n.Grammar.fromCompiled(require("./nearley-language-bootstrapped.min.js"));v=new n.Parser(v);v.feed(C);var m=r(v.results[0],{args:[e],
__proto__:f});d.rules=d.rules.concat(m.rules);d.body=d.body.concat(m.body);d.customTokens=d.customTokens.concat(m.customTokens);Object.keys(m.config).forEach(function(b){d.config[b]=m.config[b]});Object.keys(m.macros).forEach(function(b){d.macros[b]=m.macros[b]})}}else e.macro?d.macros[e.macro]={args:e.args,exprs:e.exprs}:e.config?d.config[e.config]=e.value:(h(e.name,e.rules,{}),d.start||(d.start=e.name))}return d}function B(){var t={};return function(f){var h=t[f]=(t[f]||0)+1;return f+"$"+h}}return r});
